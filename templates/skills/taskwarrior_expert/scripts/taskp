#!/bin/bash
# taskp - Task Project-Aware
# Automatically uses per-project Taskwarrior databases based on PROJECT_ID

set -e

# Detect project (priority order)
detect_project() {
    # 1. Use PROJECT_ID if set (copilot environment)
    if [ -n "$PROJECT_ID" ]; then
        echo "$PROJECT_ID"
        return
    fi
    
    # 2. Try git repository (parent_current format)
    if git rev-parse --git-dir > /dev/null 2>&1; then
        local git_root
        git_root=$(git rev-parse --show-toplevel)
        local parent
        parent=$(basename "$(dirname "$git_root")")
        local current
        current=$(basename "$git_root")
        echo "${parent}_${current}"
        return
    fi
    
    # 3. Fallback to current directory name
    basename "$PWD"
}

# Detect and set project
PROJECT=$(detect_project)

# Set TASKDATA to project-specific directory
export TASKDATA="$HOME/.task/$PROJECT"

# Create directory if it doesn't exist
mkdir -p "$TASKDATA"

# Execute task with all arguments
exec task "$@"
