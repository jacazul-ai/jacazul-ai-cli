#!/bin/bash
# taskp - Task Project-Aware
# Automatically uses per-project Taskwarrior databases based on PROJECT_ID or TASKDATA

set -e

# If TASKDATA is already set (e.g., in test harness), respect it
if [[ -n "$TASKDATA" ]]; then
    CURRENT_DATA_DIR="$TASKDATA"
else
    # Default to 'global' if PROJECT_ID is not set
    FULL_PROJECT_ID="${PROJECT_ID:-global}"
    
    # Extract root project (everything before the first colon)
    CURRENT_PROJECT_ID="${FULL_PROJECT_ID%%:*}"
    
    # Data path structure
    TASKS_BASE_DIR="$HOME/.task"
    CURRENT_DATA_DIR="$TASKS_BASE_DIR/$CURRENT_PROJECT_ID"
fi

# Ensure directory exists
if [[ ! -d "$CURRENT_DATA_DIR" ]]; then
    mkdir -p "$CURRENT_DATA_DIR"
fi

# Run task with redirected data
# We explicitly point to /root/.taskrc and override data.location
export TASKRC="$HOME/.taskrc"

# Execute the real task command
exec task rc.data.location="$CURRENT_DATA_DIR" "$@"
