#!/home/fpiraz/.candango/jaka_ai/.venv/bin/python
import sys
from tw_expert import TaskWrapper

# üêä taskp.py (v1.4.0)
# Python port of the project-aware Taskwarrior wrapper.

def main():
    args = sys.argv[1:]
    tw = TaskWrapper()
    
    # VACCINATION: Prevent direct 'done' command or manual '+DISCARDED' tag
    # BYPASS: Check if called internally (environment variable)
    internal = sys.stdin.isatty() is False or "TW_FLOW_INTERNAL" in sys.modules or True # Temporary loose bypass for porting
    # Actually, we should check for an env var like the bash version does
    import os
    is_internal = os.environ.get("TW_FLOW_INTERNAL") == "true"
    
    if not is_internal:
        for arg in args:
            if arg == "done":
                print("ERROR: Direct 'done' command via taskp is restricted to enforce proper workflow.", file=sys.stderr)
                print("Don't sweat it! Please use 'tw-flow done <uuid>' instead to capture OUTCOME.", file=sys.stderr)
                sys.exit(1)
            elif arg == "+DISCARDED":
                print("ERROR: Manual '+DISCARDED' tag via taskp is restricted.", file=sys.stderr)
                print("Please use 'tw-flow discard <uuid>' instead to properly archive tasks.", file=sys.stderr)
                sys.exit(1)

    # Special handling for 'info' to increase verbosity
    verbose = "affected,header,foot,label,columns,subtotal,stats,history,project,context,annotations" if "info" in args else "new-id"
    
    res = tw.run(args, capture=False, verbose=verbose)
    sys.exit(res.returncode)

if __name__ == "__main__":
    main()
