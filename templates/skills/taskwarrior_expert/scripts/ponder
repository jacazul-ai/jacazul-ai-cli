#!/usr/bin/env python
import sys
import os
import re
import orjson
from datetime import datetime
from typing import List, Dict, Any
from tw_expert import TaskWrapper, FocusManager

# üêä ponder (v1.4.0)
# Python port of the tactical Taskwarrior dashboard.

# Colors
CYAN = '\033[0;36m'
GREEN = '\033[0;32m'
NEON_GREEN = '\033[1;32m'
YELLOW = '\033[1;33m'
BLUE = '\033[0;34m'
RED = '\033[0;31m'
BLOODY_RED = '\033[1;31m'
NC = '\033[0m'

class Dashboard:
    def __init__(self, project_root: str = "copilot", show_all: bool = False):
        self.project_root = project_root
        self.show_all = show_all
        self.tw = TaskWrapper()
        self.focus = FocusManager()
        self.state = self.focus.load()

    def is_interesting(self, ini: str) -> bool:
        if self.show_all:
            return True
        if not self.state.inis_of_interest:
            return True
        if ini == self.state.focused_ini:
            return True
        return ini in self.state.inis_of_interest

    def render(self):
        # Fetch all pending tasks
        all_tasks = self.tw.export(["status:pending"])
        # Filter: project must be a string and not None
        all_tasks = [t for t in all_tasks if isinstance(t.get("project"), str)]
        
        print(f"{CYAN}‚ïê‚ïê TACTICAL VIEW: {self.project_root} ‚ïê‚ïê{NC}")
        
        # 1. Pulse Summary
        pending_count = len(all_tasks)
        active_count = len([t for t in all_tasks if t.get("start")])
        now_str = datetime.now().strftime("%Y%m%dT%H%M%SZ")
        overdue_count = len([t for t in all_tasks if t.get("due") and t["due"] < now_str])
        
        # Completed today
        comp_today = self.tw.export(["status:completed", "end:today"])
        comp_count = len([t for t in comp_today if isinstance(t.get("project"), str) and t["project"].startswith(self.project_root)])
        
        print(f"Pulse: Pending ({CYAN}{pending_count}{NC}) | Active ({NEON_GREEN}{active_count}{NC}) | "
              f"Overdue ({BLOODY_RED}{overdue_count}{NC}) | Done Today ({GREEN}{comp_count}{NC})\n")

        # 2. Initiative Landscape
        print(f"{YELLOW}[INITIATIVE LANDSCAPE]{NC}")
        projects = sorted(list(set(t["project"] for t in all_tasks)))
        for p in projects:
            if "_archive" in p or "_trash" in p:
                continue
            if not self.is_interesting(p):
                continue
            
            p_tasks = [t for t in all_tasks if t["project"] == p]
            p_active = len([t for t in p_tasks if t.get("start")])
            p_ready = len([t for t in p_tasks if not t.get("depends")])
            p_total = len(p_tasks)
            
            icon = "‚óã"
            if p == self.state.focused_ini:
                icon = "üìå"
            elif p_active > 0:
                icon = f"{NEON_GREEN}‚ö°{NC}"
            
            display_name = p.replace(f"{self.project_root}:", "")
            if display_name == self.project_root:
                display_name = "[root]"
            
            print(f"  {icon} {display_name:<35} | Active: {p_active:<2} | Ready: {p_ready:<2} | Total: {p_total:<2}")
        print("")

        # 3. Tactical Readout
        print(f"{YELLOW}[TACTICAL READOUT]{NC}")
        print(f"  ST | UUID     | MODE       | INITIATIVE                | DESCRIPTION                                        | URG")
        print("  " + "-" * 124)
        
        # Sort: Active first (sort_status 2), then by urgency
        readout_tasks = [t for t in all_tasks if not re.search(r'(_archive|_trash)$', t["project"])]
        readout_tasks = [t for t in readout_tasks if self.is_interesting(t["project"])]
        
        for t in readout_tasks:
            t["sort_status"] = 2 if t.get("start") else 1
            
        readout_tasks.sort(key=lambda x: (x["sort_status"], x.get("urgency", 0)), reverse=True)
        
        for t in readout_tasks[:15]:
            self.render_task_line(t)
        print("")

    def render_task_line(self, t: Dict[str, Any]):
        uuid = t["uuid"]
        desc = t["description"]
        urgency = t.get("urgency", 0)
        start = t.get("start")
        due = t.get("due")
        project = t.get("project", "[none]")
        
        status_icon = "‚óã"
        color = NC
        if uuid == self.state.focused_task_uuid:
            status_icon = "üéØ"
            color = CYAN
        elif start:
            status_icon = "‚ö°"
            color = NEON_GREEN
        elif due and due < datetime.now().strftime("%Y%m%dT%H%M%SZ"):
            status_icon = "!!"
            color = BLOODY_RED
            
        mode = "--------"
        # Match interaction modes like [EXECUTE], [PLAN], etc.
        match = re.search(r'\[([A-Z-]+)\]', desc)
        if match:
            mode = match.group(1)
            # Remove the mode prefix from description for cleaner view
            desc = re.sub(r'\[[A-Z-]+\]\s*', '', desc)
            
        initiative = project.replace(f"{self.project_root}:", "")
        if initiative == self.project_root:
            initiative = "[root]"
        
        print(f"  {color}{status_icon:<2}{NC} | {uuid[:8]} | {mode:<10} | {initiative[:25]:<25} | "
              f"{desc[:50]:<50} | [{urgency:.1f}]")

def main():
    show_all = "--all" in sys.argv
    project_root = "copilot"
    for arg in sys.argv[1:]:
        if not arg.startswith("-"):
            project_root = arg
            break
            
    db = Dashboard(project_root, show_all)
    db.render()

if __name__ == "__main__":
    main()
