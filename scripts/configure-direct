#!/bin/bash
# Configure Direct (Native) Execution Environment

# Determine the absolute project root directory
PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

echo "Configuring direct (native) execution environment..."

# Detect OS
DETECT_OS_SCRIPT="$PROJECT_ROOT/scripts/detect-os.sh"
if [ -f "$DETECT_OS_SCRIPT" ]; then
    echo "Detecting OS..."
    . "$DETECT_OS_SCRIPT"
    echo ""
else
    echo "‚ö†Ô∏è  detect-os.sh not found. Skipping OS-specific setup."
fi

# -----------------------------------------------------------------------------
# 1. Create ~/bin directory if it doesn't exist
# -----------------------------------------------------------------------------
if [ ! -d "$HOME/bin" ]; then
    echo "Creating ~/bin directory..."
    mkdir -p "$HOME/bin"
fi

# -----------------------------------------------------------------------------
# 2. Create wrapper script in ~/bin
# -----------------------------------------------------------------------------
TARGET_SCRIPT="$HOME/bin/copilot-direct"
echo "Creating wrapper script at $TARGET_SCRIPT..."

cat <<WRAPPER > "$TARGET_SCRIPT"
#!/bin/bash
export PROJECT_ROOT="$PROJECT_ROOT"

# Execute the direct copilot script
"\$PROJECT_ROOT/scripts/copilot-direct" "\$@"
WRAPPER

chmod +x "$TARGET_SCRIPT"
echo "‚úÖ Wrapper script created: $TARGET_SCRIPT"

# -----------------------------------------------------------------------------
# Function: setup_link
# Usage: setup_link <source_path> <target_link>
# -----------------------------------------------------------------------------
setup_link() {
    local source_path="$1"
    local target_link="$2"
    local link_name=$(basename "$target_link")

    if [ -L "$target_link" ]; then
        local current_target=$(readlink -f "$target_link")
        local expected_target=$(readlink -f "$source_path")
        
        if [ "$current_target" != "$expected_target" ]; then
            echo "‚ö†Ô∏è  $link_name points to wrong location. Re-linking..."
            rm "$target_link"
            ln -s "$source_path" "$target_link"
            echo "‚úÖ $link_name updated: $target_link -> $source_path"
        else
            echo "‚ÑπÔ∏è  $link_name already correctly linked."
        fi
    elif [ -f "$target_link" ]; then
        echo "‚ö†Ô∏è  $target_link is a regular file. Skipping link creation to avoid data loss."
    else
        echo "Creating symbolic link for $link_name at $target_link..."
        ln -s "$source_path" "$target_link"
        echo "‚úÖ Link created: $target_link"
    fi
}

# -----------------------------------------------------------------------------
# 3. Setup Tool Links in ~/bin
# -----------------------------------------------------------------------------
setup_link "$PROJECT_ROOT/scripts/jacazul-gemini" "$HOME/bin/jacazul-gemini"
setup_link "$PROJECT_ROOT/scripts/jacazul-opencode" "$HOME/bin/jacazul-opencode"
setup_link "$PROJECT_ROOT/scripts/jacazul-copilot" "$HOME/bin/jacazul-copilot"

# -----------------------------------------------------------------------------
# 6. OS-Specific Setup
# -----------------------------------------------------------------------------
if [ "$OS_TYPE" = "fedora" ]; then
    echo ""
    printf "\033[1;34m=========================================\033[0m\n"
    printf "\033[1;32m Running Fedora-specific setup\033[0m\n"
    printf "\033[1;34m=========================================\033[0m\n\n"
    bash "$PROJECT_ROOT/scripts/direct/setup-fedora.sh"
elif [ "$OS_TYPE" = "debian" ]; then
    echo ""
    printf "\033[1;34m=========================================\033[0m\n"
    printf "\033[1;32m Running Debian-specific setup\033[0m\n"
    printf "\033[1;34m=========================================\033[0m\n\n"
    if [ -f "$PROJECT_ROOT/scripts/direct/setup-debian.sh" ]; then
        bash "$PROJECT_ROOT/scripts/direct/setup-debian.sh"
    else
        echo "‚ö†Ô∏è  direct/setup-debian.sh not found yet"
    fi
fi

# -----------------------------------------------------------------------------
# 7. Configure Taskwarrior database location
# -----------------------------------------------------------------------------
echo ""
echo "üìù Taskwarrior database will use per-project structure:"
echo "   ~/.jacazul-ai/.task/\$PROJECT_ID/"
echo ""
echo "   This is automatically handled by taskp, tw-flow, and ponder scripts."

echo ""
echo "============================================"
echo "‚úÖ Direct environment configured!"
echo "============================================"
echo ""
echo "You can now run:"
echo "  copilot-direct"
echo "  jacazul-copilot"
echo "  jacazul-gemini"
echo "  jacazul-opencode"
echo ""
echo "Or add ~/bin to your PATH permanently:"
echo "  echo 'export PATH=\"\$HOME/bin:\$PATH\"' >> ~/.bashrc"
echo "  source ~/.bashrc"
