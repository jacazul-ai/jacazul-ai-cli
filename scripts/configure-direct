#!/bin/bash
# Configure Direct (Native) Execution Environment

# Determine the absolute project root directory
PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

echo "Configuring direct (native) execution environment..."

# Detect OS
DETECT_OS_SCRIPT="$PROJECT_ROOT/scripts/detect-os.sh"
if [ -f "$DETECT_OS_SCRIPT" ]; then
    echo "Detecting OS..."
    . "$DETECT_OS_SCRIPT"
    echo ""
else
    echo "‚ö†Ô∏è  detect-os.sh not found. Skipping OS-specific setup."
fi

# -----------------------------------------------------------------------------
# 1. Create ~/bin directory if it doesn't exist
# -----------------------------------------------------------------------------
if [ ! -d "$HOME/bin" ]; then
    echo "Creating ~/bin directory..."
    mkdir -p "$HOME/bin"
fi

# -----------------------------------------------------------------------------
# 2. Create wrapper script in ~/bin
# -----------------------------------------------------------------------------
TARGET_SCRIPT="$HOME/bin/copilot-direct"
echo "Creating wrapper script at $TARGET_SCRIPT..."

cat <<WRAPPER > "$TARGET_SCRIPT"
#!/bin/bash
export PROJECT_ROOT="$PROJECT_ROOT"

# Execute the direct copilot script
"\$PROJECT_ROOT/scripts/copilot-direct" "\$@"
WRAPPER

chmod +x "$TARGET_SCRIPT"
echo "‚úÖ Wrapper script created: $TARGET_SCRIPT"

# -----------------------------------------------------------------------------
# 5. Setup can-opencode link in ~/bin
# -----------------------------------------------------------------------------
OPENCODE_LINK="$HOME/bin/can-opencode"
if [ ! -L "$OPENCODE_LINK" ] && [ ! -f "$OPENCODE_LINK" ]; then
    echo "Creating symbolic link for can-opencode at $OPENCODE_LINK..."
    ln -s "$PROJECT_ROOT/scripts/can-opencode" "$OPENCODE_LINK"
    echo "‚úÖ Link created: $OPENCODE_LINK"
else
    echo "‚ÑπÔ∏è  $OPENCODE_LINK already exists. Skipping link creation."
fi

# -----------------------------------------------------------------------------
# 6. OS-Specific Setup
# -----------------------------------------------------------------------------
if [ "$OS_TYPE" = "fedora" ]; then
    echo ""
    printf "\033[1;34m=========================================\033[0m\n"
    printf "\033[1;32m Running Fedora-specific setup\033[0m\n"
    printf "\033[1;34m=========================================\033[0m\n\n"
    bash "$PROJECT_ROOT/scripts/direct/setup-fedora.sh"
elif [ "$OS_TYPE" = "debian" ]; then
    echo ""
    printf "\033[1;34m=========================================\033[0m\n"
    printf "\033[1;32m Running Debian-specific setup\033[0m\n"
    printf "\033[1;34m=========================================\033[0m\n\n"
    if [ -f "$PROJECT_ROOT/scripts/direct/setup-debian.sh" ]; then
        bash "$PROJECT_ROOT/scripts/direct/setup-debian.sh"
    else
        echo "‚ö†Ô∏è  direct/setup-debian.sh not found yet"
    fi
fi

# -----------------------------------------------------------------------------
# 6. Configure Taskwarrior database location
# -----------------------------------------------------------------------------
echo ""
echo "üìù Taskwarrior database will use per-project structure:"
echo "   ~/.task/\$PROJECT_ID/"
echo ""
echo "   Example: ~/.task/piraz_ai_cli_sandboxed/"
echo ""
echo "   This is automatically handled by taskp, tw-flow, and ponder scripts."

echo ""
echo "============================================"
echo "‚úÖ Direct environment configured!"
echo "============================================"
echo ""
echo "You can now run:"
echo "  copilot-direct"
echo ""
echo "Or add ~/bin to your PATH permanently:"
echo "  echo 'export PATH=\"\$HOME/bin:\$PATH\"' >> ~/.bashrc"
echo "  source ~/.bashrc"
