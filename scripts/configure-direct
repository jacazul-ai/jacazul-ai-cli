#!/bin/bash
# Configure Direct (Native) Execution Environment

# Determine the absolute project root directory
PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

echo "Configuring direct (native) execution environment..."

# Detect OS
DETECT_OS_SCRIPT="$PROJECT_ROOT/scripts/detect-os.sh"
if [ -f "$DETECT_OS_SCRIPT" ]; then
    echo "Detecting OS..."
    . "$DETECT_OS_SCRIPT"
    echo ""
else
    echo "‚ö†Ô∏è  detect-os.sh not found. Skipping OS-specific setup."
fi

# -----------------------------------------------------------------------------
# 1. Create ~/bin directory if it doesn't exist
# -----------------------------------------------------------------------------
if [ ! -d "$HOME/bin" ]; then
    echo "Creating ~/bin directory..."
    mkdir -p "$HOME/bin"
fi

# -----------------------------------------------------------------------------
# 2. Create wrapper script in ~/bin
# -----------------------------------------------------------------------------
TARGET_SCRIPT="$HOME/bin/copilot-direct"
echo "Creating wrapper script at $TARGET_SCRIPT..."

cat <<WRAPPER > "$TARGET_SCRIPT"
#!/bin/bash
export PROJECT_ROOT="$PROJECT_ROOT"

# Execute the direct copilot script
"\$PROJECT_ROOT/scripts/copilot-direct" "\$@"
WRAPPER

chmod +x "$TARGET_SCRIPT"
echo "‚úÖ Wrapper script created: $TARGET_SCRIPT"

# -----------------------------------------------------------------------------
# 3. Setup jacazul-gemini link in ~/bin
# -----------------------------------------------------------------------------
GEMINI_LINK="$HOME/bin/jacazul-gemini"
if [ ! -L "$GEMINI_LINK" ] && [ ! -f "$GEMINI_LINK" ]; then
    echo "Creating symbolic link for jacazul-gemini at $GEMINI_LINK..."
    ln -s "$PROJECT_ROOT/scripts/jacazul-gemini" "$GEMINI_LINK"
    echo "‚úÖ Link created: $GEMINI_LINK"
else
    echo "‚ÑπÔ∏è  $GEMINI_LINK already exists. Skipping link creation."
fi

# -----------------------------------------------------------------------------
# 4. Setup jacazul-opencode link in ~/bin
# -----------------------------------------------------------------------------
OPENCODE_LINK="$HOME/bin/jacazul-opencode"
if [ ! -L "$OPENCODE_LINK" ] && [ ! -f "$OPENCODE_LINK" ]; then
    echo "Creating symbolic link for jacazul-opencode at $OPENCODE_LINK..."
    ln -s "$PROJECT_ROOT/scripts/jacazul-opencode" "$OPENCODE_LINK"
    echo "‚úÖ Link created: $OPENCODE_LINK"
else
    echo "‚ÑπÔ∏è  $OPENCODE_LINK already exists. Skipping link creation."
fi

# -----------------------------------------------------------------------------
# 5. Setup jacazul-copilot link in ~/bin
# -----------------------------------------------------------------------------
COPILOT_LINK="$HOME/bin/jacazul-copilot"
if [ ! -L "$COPILOT_LINK" ] && [ ! -f "$COPILOT_LINK" ]; then
    echo "Creating symbolic link for jacazul-copilot at $COPILOT_LINK..."
    ln -s "$PROJECT_ROOT/scripts/jacazul-copilot" "$COPILOT_LINK"
    echo "‚úÖ Link created: $COPILOT_LINK"
else
    echo "‚ÑπÔ∏è  $COPILOT_LINK already exists. Skipping link creation."
fi

# -----------------------------------------------------------------------------
# 6. OS-Specific Setup
# -----------------------------------------------------------------------------
if [ "$OS_TYPE" = "fedora" ]; then
    echo ""
    printf "\033[1;34m=========================================\033[0m\n"
    printf "\033[1;32m Running Fedora-specific setup\033[0m\n"
    printf "\033[1;34m=========================================\033[0m\n\n"
    bash "$PROJECT_ROOT/scripts/direct/setup-fedora.sh"
elif [ "$OS_TYPE" = "debian" ]; then
    echo ""
    printf "\033[1;34m=========================================\033[0m\n"
    printf "\033[1;32m Running Debian-specific setup\033[0m\n"
    printf "\033[1;34m=========================================\033[0m\n\n"
    if [ -f "$PROJECT_ROOT/scripts/direct/setup-debian.sh" ]; then
        bash "$PROJECT_ROOT/scripts/direct/setup-debian.sh"
    else
        echo "‚ö†Ô∏è  direct/setup-debian.sh not found yet"
    fi
fi

# -----------------------------------------------------------------------------
# 7. Configure Taskwarrior database location
# -----------------------------------------------------------------------------
echo ""
echo "üìù Taskwarrior database will use per-project structure:"
echo "   ~/.jacazul-ai/.task/\$PROJECT_ID/"
echo ""
echo "   This is automatically handled by taskp, tw-flow, and ponder scripts."

echo ""
echo "============================================"
echo "‚úÖ Direct environment configured!"
echo "============================================"
echo ""
echo "You can now run:"
echo "  copilot-direct"
echo "  jacazul-copilot"
echo "  jacazul-gemini"
echo "  jacazul-opencode"
echo ""
echo "Or add ~/bin to your PATH permanently:"
echo "  echo 'export PATH=\"\$HOME/bin:\$PATH\"' >> ~/.bashrc"
echo "  source ~/.bashrc"
