#!/bin/bash
# Configure Direct (Native) Execution Environment

# Determine the absolute project root directory
PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

echo "Configuring direct (native) execution environment..."
echo "Project root: $PROJECT_ROOT"
echo ""

# -----------------------------------------------------------------------------
# 0. Initialize Jaka Bootstrap Environment
# -----------------------------------------------------------------------------
BOOTSTRAP_ENV="$PROJECT_ROOT/scripts/bootstrap/environment"
if [ -f "$BOOTSTRAP_ENV" ]; then
    echo "üêä Running Jaka bootstrap environment initialization..."
    source "$BOOTSTRAP_ENV"
    echo ""
else
    echo "‚ö†Ô∏è  Bootstrap environment script not found at $BOOTSTRAP_ENV."
fi

# Detect OS
DETECT_OS_SCRIPT="$PROJECT_ROOT/scripts/detect-os.sh"
if [ -f "$DETECT_OS_SCRIPT" ]; then
    echo "Detecting OS..."
    . "$DETECT_OS_SCRIPT"
    echo ""
else
    echo "‚ö†Ô∏è  detect-os.sh not found. Skipping OS-specific setup."
fi

# -----------------------------------------------------------------------------
# 1. Create ~/bin directory if it doesn't exist
# -----------------------------------------------------------------------------
if [ ! -d "$HOME/bin" ]; then
    echo "Creating ~/bin directory..."
    mkdir -p "$HOME/bin"
fi

# -----------------------------------------------------------------------------
# 2. Create wrapper script in ~/bin
# -----------------------------------------------------------------------------
TARGET_SCRIPT="$HOME/bin/copilot-direct"
echo "Creating wrapper script at $TARGET_SCRIPT..."

cat <<WRAPPER > "$TARGET_SCRIPT"
#!/bin/bash
export PROJECT_ROOT="$PROJECT_ROOT"

# Execute the direct copilot script
"\$PROJECT_ROOT/scripts/copilot-direct" "\$@"
WRAPPER

chmod +x "$TARGET_SCRIPT"
echo "‚úÖ Wrapper script created: $TARGET_SCRIPT"

# -----------------------------------------------------------------------------
# 3. Symlink skills to native home
# -----------------------------------------------------------------------------
SKILL_SOURCE="$PROJECT_ROOT/templates/skills"
SKILL_TARGET="$HOME/.copilot/skills"

if [ ! -d "$HOME/.copilot" ]; then
    echo "Creating ~/.copilot directory..."
    mkdir -p "$HOME/.copilot"
fi

if [ -L "$SKILL_TARGET" ]; then
    echo "‚ö†Ô∏è  Skill symlink already exists: $SKILL_TARGET"
elif [ -d "$SKILL_TARGET" ]; then
    echo "‚ö†Ô∏è  Skills directory already exists (not a symlink): $SKILL_TARGET"
    echo "    Skipping skill setup. Remove it first if you want to use project skills."
else
    echo "Creating skill symlink: $SKILL_TARGET -> $SKILL_SOURCE"
    ln -s "$SKILL_SOURCE" "$SKILL_TARGET"
    echo "‚úÖ Skills symlinked"
fi

# -----------------------------------------------------------------------------
# 4. Symlink templates to custom instructions
# -----------------------------------------------------------------------------
TEMPLATES_SOURCE="$PROJECT_ROOT/templates"
TEMPLATES_TARGET="$HOME/.copilot/templates"

if [ -L "$TEMPLATES_TARGET" ]; then
    echo "‚ö†  Templates symlink already exists: $TEMPLATES_TARGET"
elif [ -d "$TEMPLATES_TARGET" ]; then
    echo "‚ö†Ô∏è  Templates directory already exists (not a symlink): $TEMPLATES_TARGET"
    echo "    Skipping templates setup."
else
    echo "Creating templates symlink: $TEMPLATES_TARGET -> $TEMPLATES_SOURCE"
    ln -s "$TEMPLATES_SOURCE" "$TEMPLATES_TARGET"
    echo "‚úÖ Templates symlinked"
fi

# -----------------------------------------------------------------------------
# 5. Setup can-opencode link in ~/bin
# -----------------------------------------------------------------------------
OPENCODE_LINK="$HOME/bin/can-opencode"
if [ ! -L "$OPENCODE_LINK" ] && [ ! -f "$OPENCODE_LINK" ]; then
    echo "Creating symbolic link for can-opencode at $OPENCODE_LINK..."
    ln -s "$PROJECT_ROOT/scripts/can-opencode" "$OPENCODE_LINK"
    echo "‚úÖ Link created: $OPENCODE_LINK"
else
    echo "‚ÑπÔ∏è  $OPENCODE_LINK already exists. Skipping link creation."
fi

# -----------------------------------------------------------------------------
# 6. OS-Specific Setup
# -----------------------------------------------------------------------------
if [ "$OS_TYPE" = "fedora" ]; then
    echo ""
    printf "\033[1;34m=========================================\033[0m\n"
    printf "\033[1;32m Running Fedora-specific setup\033[0m\n"
    printf "\033[1;34m=========================================\033[0m\n\n"
    bash "$PROJECT_ROOT/scripts/direct/setup-fedora.sh"
elif [ "$OS_TYPE" = "debian" ]; then
    echo ""
    printf "\033[1;34m=========================================\033[0m\n"
    printf "\033[1;32m Running Debian-specific setup\033[0m\n"
    printf "\033[1;34m=========================================\033[0m\n\n"
    if [ -f "$PROJECT_ROOT/scripts/direct/setup-debian.sh" ]; then
        bash "$PROJECT_ROOT/scripts/direct/setup-debian.sh"
    else
        echo "‚ö†Ô∏è  direct/setup-debian.sh not found yet"
    fi
fi

# -----------------------------------------------------------------------------
# 6. Configure Taskwarrior database location
# -----------------------------------------------------------------------------
echo ""
echo "üìù Taskwarrior database will use per-project structure:"
echo "   ~/.task/\$PROJECT_ID/"
echo ""
echo "   Example: ~/.task/piraz_ai_cli_sandboxed/"
echo ""
echo "   This is automatically handled by taskp, tw-flow, and ponder scripts."

echo ""
echo "============================================"
echo "‚úÖ Direct environment configured!"
echo "============================================"
echo ""
echo "You can now run:"
echo "  copilot-direct"
echo ""
echo "Or add ~/bin to your PATH permanently:"
echo "  echo 'export PATH=\"\$HOME/bin:\$PATH\"' >> ~/.bashrc"
echo "  source ~/.bashrc"
