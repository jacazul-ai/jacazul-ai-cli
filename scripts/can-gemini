#!/bin/bash
# can-gemini: Gemini CLI unhinged (direct execution)

# Get the absolute path to the script's directory
SCRIPT_DIR="$(dirname "$(readlink -f "$0")")"
PROJECT_ROOT="$(readlink -f "$SCRIPT_DIR/..")"

# -----------------------------------------------------------------------------
# Runtime Bootstrap (Dynamics)
# -----------------------------------------------------------------------------
BOOTSTRAP_ENV="$PROJECT_ROOT/scripts/bootstrap/environment"
if [ -f "$BOOTSTRAP_ENV" ]; then
    source "$BOOTSTRAP_ENV"
else
    echo "‚ùå Jaka runtime environment not found at $BOOTSTRAP_ENV" >&2
    exit 1
fi

# Export context for Gemini CLI
export PROJECT_ID="$PROJECT_ID"
export GEMINI_INSTRUCTIONS_DIR="$PROJECT_ROOT/templates/context/instructions"

# Add workflow scripts to PATH
export PATH="$PATH:$PROJECT_ROOT/templates/skills/taskwarrior_expert/scripts"

# Determine User Name for Prompt
USER_NAME="${CONTEXT_GIT_USER:-$(whoami)}"

# Base Onboard Prompt for Jaka
ONBOARD_PROMPT="Initialize session. You are Jaka, o Jacar√© Azul (Monstro do Lago), running $JAKA_MODE in a direct shell environment. You are assisting user $USER_NAME. The current project context is id $PROJECT_ID. \
\
ACTION REQUIRED: \
1. Activate skill 'jaka' and 'taskwarrior-expert' immediately. \
2. When the user says 'onboard', follow the Onboard Protocol in the Jacazul agent: display session context and run the ponder dashboard. \
\
Initially just ponder the state of $PROJECT_ID, give me your insight, and stop."

# If no arguments provided, default to deterministic onboarding
if [ $# -eq 0 ]; then
    set -- -i "$ONBOARD_PROMPT"
else
    USER_PROMPT="$*"
    set -- -i "$ONBOARD_PROMPT" "$USER_PROMPT"
fi

# Check if gemini is installed
if ! command -v gemini &> /dev/null; then
    echo "‚ùå gemini command not found in PATH." >&2
    exit 1
fi

[ -n "$DEBUG" ] && echo "üêä can-gemini: Starting for project [$PROJECT_ID]"

# DRY RUN: Exit before execution if DRY is set
if [ -n "$DRY" ]; then
    echo "‚úÖ Dry run complete. Gemini bootstrap verified for project [$PROJECT_ID]."
    exit 0
fi

exec gemini "$@"
