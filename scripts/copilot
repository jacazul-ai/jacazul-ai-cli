#!/bin/bash
[ -n "$DEBUG" ] && set -x

# Get the absolute path to the script's directory
SCRIPT_DIR="$(dirname "$(readlink -f "$0")")"
TEMPLATES_TASKRC="$SCRIPT_DIR/../templates/.taskrc"

# Define host directories
HOST_SANDBOX=$COPILOT_SANDBOXED_HOME/sandbox/copilot
HOST_SANDBOX_CONFIG_DIR="$HOST_SANDBOX/.config"
HOST_SANDBOX_COPILOT_DIR="$HOST_SANDBOX/.copilot"
HOST_SANDBOX_NPM_DIR="$HOST_SANDBOX/.npm"
HOST_SANDBOX_TASK_DIR="$HOST_SANDBOX/.task"
HOST_GITCONFIG="$HOST_SANDBOX/.gitconfig"

# Create directories if they don't exist
mkdir -p "$HOST_SANDBOX_CONFIG_DIR" "$HOST_SANDBOX_COPILOT_DIR" "$HOST_SANDBOX_NPM_DIR" "$HOST_SANDBOX_TASK_DIR"

# Setup Python venv in sandbox if it does not exist
HOST_VENV_DIR="$HOST_SANDBOX/venv"
if [ ! -d "$HOST_VENV_DIR" ]; then
    echo "ðŸ“ Creating venv directory: $HOST_VENV_DIR"
    mkdir -p "$HOST_VENV_DIR"
fi

# Calculate Project Identity (following gemini pattern)
PARENT_DIR=$(basename "$(dirname "$(pwd)")")
CURRENT_DIR=$(basename "$(pwd)")
PROJECT_ID="${PARENT_DIR}_${CURRENT_DIR}"

# -----------------------------------------------------------------------------
# 0. Initialize Jaka Bootstrap Environment
# -----------------------------------------------------------------------------
BOOTSTRAP_ENV="$SCRIPT_DIR/bootstrap/environment"
if [ -f "$BOOTSTRAP_ENV" ]; then
    source "$BOOTSTRAP_ENV"
fi

# Set JAKA_MODE to CAGED for this script
export JAKA_MODE="CAGED"

# Initialize Taskwarrior Bootstrap
BOOTSTRAP_TW="$SCRIPT_DIR/bootstrap/taskwarrior"
if [ -f "$BOOTSTRAP_TW" ]; then
    source "$BOOTSTRAP_TW"
fi

# Capture complete session context for onboard
REAL_PATH="$(pwd)"
SYSTEM_USER="$(whoami)"

# Check if git credentials are configured
if [ ! -f "$HOST_GITCONFIG" ]; then
    echo "==================================="
    echo "Git Configuration Setup"
    echo "==================================="
    echo ""
    
    # Try to get git credentials from host
    GIT_USER_NAME=$(git config --global user.name 2>/dev/null)
    GIT_USER_EMAIL=$(git config --global user.email 2>/dev/null)
    
    # If not found, prompt user
    if [ -z "$GIT_USER_NAME" ]; then
        read -p "Enter your Git user name: " GIT_USER_NAME
    else
        echo "âœ“ Found Git user name: $GIT_USER_NAME"
    fi
    
    if [ -z "$GIT_USER_EMAIL" ]; then
        read -p "Enter your Git email: " GIT_USER_EMAIL
    else
        echo "âœ“ Found Git email: $GIT_USER_EMAIL"
    fi
    
    # Create gitconfig file
    cat > "$HOST_GITCONFIG" <<GITEOF
[user]
name = $GIT_USER_NAME
email = $GIT_USER_EMAIL
[init]
defaultBranch = main
[core]
editor = vim
GITEOF
    
    echo ""
    echo "âœ“ Git configuration saved to $HOST_GITCONFIG"
    echo ""
fi

# Load git credentials if not already set
if [ -z "$GIT_USER_NAME" ]; then
    GIT_USER_NAME=$(grep -A2 '^\[user\]' "$HOST_GITCONFIG" | grep 'name' | cut -d'=' -f2 | xargs 2>/dev/null || echo "not configured")
    GIT_USER_EMAIL=$(grep -A2 '^\[user\]' "$HOST_GITCONFIG" | grep 'email' | cut -d'=' -f2 | xargs 2>/dev/null || echo "not configured")
fi
# Default to Jacazul agent if no --agent specified
AGENT_ARGS=()
HAS_AGENT=false

for arg in "$@"; do
    if [[ "$arg" == --agent=* ]] || [[ "$arg" == --agent ]]; then
        HAS_AGENT=true
        break
    fi
done

if [ "$HAS_AGENT" = false ]; then
    AGENT_ARGS=(--agent=jacazul)
fi


# Run the container as jacazul user
# All volumes now mount to /home/jacazul
podman run -it --rm \
  ${DEBUG:+--log-level debug} \
  --userns=keep-id \
  -e "JAKA_MODE=$JAKA_MODE" \
  -e "COPILOT_CUSTOM_INSTRUCTIONS_DIRS=/home/jacazul/.copilot:/home/jacazul/.github/instructions" \
  -e "PROJECT_ID=$PROJECT_ID" \
  -e "CONTEXT_REAL_PATH=$REAL_PATH" \
  -e "CONTEXT_SYSTEM_USER=$SYSTEM_USER" \
  -e "CONTEXT_GIT_USER=$GIT_USER_NAME" \
  -e "CONTEXT_GIT_EMAIL=$GIT_USER_EMAIL" \
  -e "CONTEXT_PARENT_DIR=$PARENT_DIR" \
  -e "CONTEXT_CURRENT_DIR=$CURRENT_DIR" \
  -v "$(pwd):/project:z" \
  -w /project \
  -v "$HOST_SANDBOX_CONFIG_DIR:/home/jacazul/.config:z" \
  -v "$HOST_SANDBOX_COPILOT_DIR:/home/jacazul/.copilot:z" \
  -v "$HOST_SANDBOX_NPM_DIR:/home/jacazul/.npm:z" \
  -v "$TASKDATA:/home/jacazul/.task:z" \
  -v "$SCRIPT_DIR/../templates/context/copilot-instructions.md:/home/jacazul/.copilot/copilot-instructions.md:z" \
  -v "$SCRIPT_DIR/../templates/context/instructions:/home/jacazul/.github/instructions:z" \
  -v "$TEMPLATES_TASKRC:/home/jacazul/.taskrc:z" \
  -v "$SCRIPT_DIR/../templates/skills:/home/jacazul/.copilot/skills:z" \
  -v "$SCRIPT_DIR/../templates/agents:/home/jacazul/.copilot/agents:z" \
  -v "$HOST_GITCONFIG:/home/jacazul/.gitconfig:z" \
  -v "$HOST_VENV_DIR:/project/sandbox/venv:z" \
  ai-sandbox "${AGENT_ARGS[@]}" "$@"
