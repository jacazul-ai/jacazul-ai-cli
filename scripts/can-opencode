#!/bin/bash
# can-opencode: Opencode CLI unhinged (direct execution)

# Get the absolute path to the script's directory
SCRIPT_DIR="$(dirname "$(readlink -f "$0")")"
PROJECT_ROOT="$(readlink -f "$SCRIPT_DIR/..")"

# -----------------------------------------------------------------------------
# Runtime Bootstrap (Dynamics)
# -----------------------------------------------------------------------------
BOOTSTRAP_ENV="$PROJECT_ROOT/scripts/bootstrap/environment"
if [ -f "$BOOTSTRAP_ENV" ]; then
    source "$BOOTSTRAP_ENV"
else
    echo "‚ùå Jaka runtime environment not found at $BOOTSTRAP_ENV" >&2
    exit 1
fi

# Export context for TUI
export PROJECT_ID="$PROJECT_ID"
export CONTEXT_REAL_PATH="$(pwd)"
export CONTEXT_SYSTEM_USER="$(whoami)"

# Add workflow scripts to PATH
export PATH="$PATH:$PROJECT_ROOT/templates/skills/taskwarrior_expert/scripts"

# Check if opencode is installed
OPENCODE_BIN=$(which opencode 2>/dev/null || echo "/home/fpiraz/.opencode/bin/opencode")

if [ ! -x "$OPENCODE_BIN" ]; then
    echo "‚ùå opencode command not found or not executable at $OPENCODE_BIN" >&2
    exit 1
fi

[ -n "$DEBUG" ] && echo "üêä can-opencode: Starting for project [$PROJECT_ID]"

# DRY RUN: Exit before execution if DRY is set
if [ -n "$DRY" ]; then
    echo "‚úÖ Dry run complete. Opencode bootstrap verified for project [$PROJECT_ID]."
    exit 0
fi

# Execute opencode with jacazul agent by default
if [[ "$*" == *"--agent"* ]]; then
    exec "$OPENCODE_BIN" "$@"
else
    exec "$OPENCODE_BIN" --agent jacazul "$@"
fi
