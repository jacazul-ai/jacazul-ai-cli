#!/bin/bash
# üêä Jaka Bootstrap - Environment Check
# This script is the SOLE entry point for runtime configuration (Dynamics).

# 1. Run-once Guard
if [ -n "$JAKA_ENV_INITIALIZED" ]; then
    return 0
fi

# 2. Dynamic Detection of Real Taskwarrior Binary
if [ -z "$JAKA_REAL_TASK" ]; then
    JAKA_REAL_TASK=$(which -a task 2>/dev/null | grep -v "$PROJECT_ROOT/scripts/task" | head -n 1)
    if [ -z "$JAKA_REAL_TASK" ]; then
        for p in /usr/bin/task /usr/local/bin/task /opt/homebrew/bin/task; do
            if [ -x "$p" ]; then JAKA_REAL_TASK="$p"; break; fi
        done
    fi
    export JAKA_REAL_TASK
fi

# 2.1 Administrative Alias
# Provides a session-specific bypass to the real binary for project maintenance.
alias rtask="$JAKA_REAL_TASK"

# 3. Project Identity Calculation
if [ -z "$PROJECT_ID" ]; then
    PARENT_DIR=$(basename "$(dirname "$(pwd)")")
    CURRENT_DIR=$(basename "$(pwd)")
    export PROJECT_ID="${PARENT_DIR}_${CURRENT_DIR}"
fi

# 4. Mode Configuration
export JAKA_MODE="${JAKA_MODE:-UNHINGED}"

# 4. Component Bootstraps (Dynamics)
# 4.1 Taskwarrior
BOOTSTRAP_TW="$PROJECT_ROOT/scripts/bootstrap/taskwarrior"
[ -f "$BOOTSTRAP_TW" ] && source "$BOOTSTRAP_TW"

# 4.2 Gemini
BOOTSTRAP_GEMINI="$PROJECT_ROOT/scripts/bootstrap/gemini"
[ -f "$BOOTSTRAP_GEMINI" ] && source "$BOOTSTRAP_GEMINI" "$HOME/.gemini"

# 4.3 Opencode
BOOTSTRAP_OPENCODE="$PROJECT_ROOT/scripts/bootstrap/opencode"
if [ -x "$BOOTSTRAP_OPENCODE" ]; then
    # We call it as a script to maintain its internal logic
    "$BOOTSTRAP_OPENCODE"
fi

# 4.4 Copilot
BOOTSTRAP_COPILOT="$PROJECT_ROOT/scripts/bootstrap/copilot"
if [ -x "$BOOTSTRAP_COPILOT" ]; then
    "$BOOTSTRAP_COPILOT"
fi

# 4.5 Python VENV
BOOTSTRAP_PYTHON="$PROJECT_ROOT/scripts/bootstrap/python"
[ -f "$BOOTSTRAP_PYTHON" ] && source "$BOOTSTRAP_PYTHON"

# 5. Finalize Initialization
export JAKA_ENV_INITIALIZED=true

# Initial feedback - ONLY if DEBUG is set
if [ -n "$DEBUG" ]; then
    echo "üêä Jaka Runtime Initialized | Mode: $JAKA_MODE | Binary: ${JAKA_REAL_TASK:-not found}"
fi
