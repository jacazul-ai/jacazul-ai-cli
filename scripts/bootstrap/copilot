#!/bin/bash
# üêä Jacazul - Bootstrap for Copilot (Global UNHINGED Mode)
# Sets up global agents and skills for native Copilot CLI execution.

PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"
COPILOT_GLOBAL_DIR="$HOME/.copilot"
TEMPLATES_DIR="$PROJECT_ROOT/templates"

# 1. Garante que os diret√≥rios globais existem
if [ ! -d "$COPILOT_GLOBAL_DIR/agents" ] || [ ! -d "$COPILOT_GLOBAL_DIR/skills" ]; then
    echo "üêä Initializing global Copilot directories at $COPILOT_GLOBAL_DIR..."
    mkdir -p "$COPILOT_GLOBAL_DIR/agents" "$COPILOT_GLOBAL_DIR/skills"
fi

# 2. Link Global Agents (Surgical)
# Link Copilot-specific version as the default 'jacazul.agent.md'
AGENT_SRC="$TEMPLATES_DIR/agents/jacazul.copilot.md"
AGENT_TARGET="$COPILOT_GLOBAL_DIR/agents/jacazul.agent.md"

if [ -e "$AGENT_SRC" ]; then
    echo "üêä Linking global Copilot agent: jacazul"
    ln -sf "$AGENT_SRC" "$AGENT_TARGET"
fi

# 3. Link Global Skills (Surgical)
for skill_dir in "$TEMPLATES_DIR/skills"/*; do
    [ -d "$skill_dir" ] || continue
    name=$(basename "$skill_dir")
    
    # üö® EXCLUSION: jacazul is NOT a skill for Copilot, it is an agent.
    if [ "$name" = "jacazul" ]; then
        continue
    fi

    target="$COPILOT_GLOBAL_DIR/skills/$name"
    # Always ensure the link points to the CURRENT PROJECT_ROOT
    if [ -L "$target" ]; then
        current_target=$(readlink -f "$target")
        expected_target=$(readlink -f "$skill_dir")
        if [ "$current_target" != "$expected_target" ]; then
            echo "‚ö†Ô∏è  Skill $name points to wrong location. Re-linking..."
            ln -sf "$skill_dir" "$target"
        fi
    else
        echo "üêä Linking global skill: $name"
        ln -sf "$skill_dir" "$target"
    fi
done

# 4. Link Instructions Template (Surgical)
INSTRUCTIONS_SRC="$TEMPLATES_DIR/context/copilot-instructions.md"
INSTRUCTIONS_TARGET="$COPILOT_GLOBAL_DIR/copilot-instructions.md"
# Always ensure the instructions link points to the CURRENT PROJECT_ROOT
if [ -L "$INSTRUCTIONS_TARGET" ]; then
    current_target=$(readlink -f "$INSTRUCTIONS_TARGET")
    expected_target=$(readlink -f "$INSTRUCTIONS_SRC")
    if [ "$current_target" != "$expected_target" ]; then
        echo "‚ö†Ô∏è  Copilot instructions point to wrong location. Re-linking..."
        ln -sf "$INSTRUCTIONS_SRC" "$INSTRUCTIONS_TARGET"
    fi
elif [ ! -f "$INSTRUCTIONS_TARGET" ]; then
    echo "üêä Linking global instructions: $INSTRUCTIONS_TARGET"
    ln -sf "$INSTRUCTIONS_SRC" "$INSTRUCTIONS_TARGET"
fi

# Log only in DEBUG mode
if [ -n "$DEBUG" ]; then
    echo "‚úÖ Jacazul: Global Copilot environment verified."
fi
