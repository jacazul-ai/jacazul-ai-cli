#!/bin/bash
# üêä Jaka - Bootstrap for Gemini CLI Settings
# Configures experimental agents and preview features surgically.

# Localiza o diret√≥rio raiz do projeto
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"
TEMPLATES_DIR="$PROJECT_ROOT/templates"

GEMINI_DIR="${1:-$HOME/.gemini}"
SETTINGS_FILE="$GEMINI_DIR/settings.json"
TEMPLATE_SETTINGS="$PROJECT_ROOT/templates/gemini/unhinged/settings.json"

# 1. Garante que o diret√≥rio existe
if [ ! -d "$GEMINI_DIR" ]; then
    echo "üêä Creating Gemini directory at $GEMINI_DIR..."
    mkdir -p "$GEMINI_DIR"
fi

# 2. Garante que o settings.json existe (usa template se dispon√≠vel)
if [ ! -f "$SETTINGS_FILE" ]; then
    if [ -f "$TEMPLATE_SETTINGS" ]; then
        echo "üêä Initializing Gemini settings.json from template..."
        cp "$TEMPLATE_SETTINGS" "$SETTINGS_FILE"
    else
        echo "{}" > "$SETTINGS_FILE"
    fi
fi

# 3. Update cir√∫rgico com jq
# Mant√©m o que j√° existe e s√≥ garante os campos necess√°rios
TMP_FILE=$(mktemp)
jq '
    .experimental.enableAgents = true | 
    .general.previewFeatures = true
' "$SETTINGS_FILE" > "$TMP_FILE" && mv "$TMP_FILE" "$SETTINGS_FILE"

# 4. Link Global Skills (Surgical)
SKILLS_DIR="$GEMINI_DIR/skills"
mkdir -p "$SKILLS_DIR"

for skill_dir in "$TEMPLATES_DIR/skills"/*; do
    [ -d "$skill_dir" ] || continue
    name=$(basename "$skill_dir")
    
    target="$SKILLS_DIR/$name"
    if [ ! -L "$target" ] && [ ! -d "$target" ]; then
        echo "üêä Linking global Gemini skill: $name"
        ln -sf "$skill_dir" "$target"
    fi
done

# Log only in DEBUG mode
if [ -n "$DEBUG" ]; then
    echo "‚úÖ Jaka: Gemini configuration verified (enableAgents: true, previewFeatures: true)."
fi
