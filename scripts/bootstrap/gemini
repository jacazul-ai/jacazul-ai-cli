#!/bin/bash
# ðŸŠ Jaka - Bootstrap for Gemini CLI Settings
# Configures experimental agents and preview features surgically.

# Localiza o diretÃ³rio raiz do projeto
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"

GEMINI_DIR="${1:-$HOME/.gemini}"
SETTINGS_FILE="$GEMINI_DIR/settings.json"
TEMPLATE_SETTINGS="$PROJECT_ROOT/templates/gemini/unhinged/settings.json"

# 1. Garante que o diretÃ³rio existe
if [ ! -d "$GEMINI_DIR" ]; then
    echo "ðŸŠ Creating Gemini directory at $GEMINI_DIR..."
    mkdir -p "$GEMINI_DIR"
fi

# 2. Garante que o settings.json existe (usa template se disponÃ­vel)
if [ ! -f "$SETTINGS_FILE" ]; then
    if [ -f "$TEMPLATE_SETTINGS" ]; then
        echo "ðŸŠ Initializing Gemini settings.json from template..."
        cp "$TEMPLATE_SETTINGS" "$SETTINGS_FILE"
    else
        echo "{}" > "$SETTINGS_FILE"
    fi
fi

# 3. Update cirÃºrgico com jq
# MantÃ©m o que jÃ¡ existe e sÃ³ garante os campos necessÃ¡rios
TMP_FILE=$(mktemp)
jq '
    .experimental.enableAgents = true | 
    .general.previewFeatures = true
' "$SETTINGS_FILE" > "$TMP_FILE" && mv "$TMP_FILE" "$SETTINGS_FILE"

# Log only in DEBUG mode
if [ -n "$DEBUG" ]; then
    echo "âœ… Jaka: Gemini configuration verified (enableAgents: true, previewFeatures: true)."
fi
