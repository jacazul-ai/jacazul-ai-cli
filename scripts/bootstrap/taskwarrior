#!/bin/bash
# üêä Jacazul Taskwarrior Bootstrap
# Sets TASKDATA based on JACAZUL_MODE and PROJECT_ID

if [ -n "$PROJECT_ID" ]; then
    if [ "$JACAZUL_MODE" = "UNHINGED" ]; then
        export JACAZUL_HOME="$HOME/.jacazul-ai"
        export TASKRC="$JACAZUL_HOME/.taskrc"
        # In unhinged mode, we use a global task base but isolated per project
        export TASKDATA="$JACAZUL_HOME/.task/$PROJECT_ID"
        
        # Ensure the .taskrc is in place
        if [ ! -f "$TASKRC" ]; then
            echo "üêä Initializing Unhinged Taskwarrior config at $TASKRC..."
            mkdir -p "$JACAZUL_HOME"
            cp templates/taskwarrior/unhinged/.taskrc "$TASKRC"
            # Explicitly override data.location to avoid confusion, 
            # though TASKDATA env var takes precedence.
            sed -i "s|data.location=.*|data.location=$JACAZUL_HOME/.task|" "$TASKRC"
        fi
    else
        export TASKDATA="$HOME/.task/$PROJECT_ID"
    fi

    # Create task data directory if missing
    if [ ! -d "$TASKDATA" ]; then
        echo "üêä Creating task data directory: $TASKDATA"
        mkdir -p "$TASKDATA"
    fi

    # Emit logs only in DEBUG mode
    if [ -n "$DEBUG" ]; then
        echo "üêä Task Data: $TASKDATA"
        [ -n "$TASKRC" ] && echo "üêä Task RC: $TASKRC"
    fi
fi
