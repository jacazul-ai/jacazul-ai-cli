#!/bin/bash
# üêä Jaka Python Bootstrap (Unhinged Mode)
# Manages the persistent Python venv using 'uv'.

VENV_DIR="$HOME/.candango/jaka_ai/.venv"
REQUIREMENTS_FILE="$PROJECT_ROOT/templates/python/requirements.txt"

# 1. Ensure the venv directory exists
if [ ! -d "$VENV_DIR" ]; then
    echo "üêä Creating persistent Python venv at $VENV_DIR..."
    mkdir -p "$(dirname "$VENV_DIR")"
    if command -v uv &> /dev/null; then
        uv venv "$VENV_DIR"
    else
        echo "‚ö†Ô∏è  'uv' not found. Falling back to 'python3 -m venv' (slower)..."
        python3 -m venv "$VENV_DIR"
    fi
fi

# 2. Activate the venv
# shellcheck source=/dev/null
source "$VENV_DIR/bin/activate"

# 3. Sync dependencies if requirements.txt exists and we are in DEBUG or first run
if [ -f "$REQUIREMENTS_FILE" ]; then
    if [ -n "$DEBUG" ]; then
        echo "üêä Syncing Python dependencies via 'uv'..."
        uv pip install -r "$REQUIREMENTS_FILE"
    fi
fi

# Log status in DEBUG mode
if [ -n "$DEBUG" ]; then
    echo "‚úÖ Jaka: Python environment ready ($VENV_DIR)."
fi
