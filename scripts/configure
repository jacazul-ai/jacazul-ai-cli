#!/bin/bash

# Determine the absolute project root directory
PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

# -----------------------------------------------------------------------------
# 0.1 Configure Gemini CLI Settings
# -----------------------------------------------------------------------------
GEMINI_BOOTSTRAP="$PROJECT_ROOT/scripts/bootstrap/gemini"
if [ -x "$GEMINI_BOOTSTRAP" ]; then
    "$GEMINI_BOOTSTRAP"
else
    echo "⚠️  Gemini bootstrap script not found or not executable at $GEMINI_BOOTSTRAP."
fi

# -----------------------------------------------------------------------------
# 1. Setup Sandbox Directory (SELinux & Permissions)
# -----------------------------------------------------------------------------
SANDBOX_DIR="$PROJECT_ROOT/sandbox/copilot/.copilot"

echo "Configuring sandbox directory at: $SANDBOX_DIR"
mkdir -p "$SANDBOX_DIR"

# Apply SELinux label 'container_file_t' if chcon is available
if command -v chcon &> /dev/null; then
    echo "Applying SELinux context (container_file_t)..."
    if chcon -Rt container_file_t "$SANDBOX_DIR"; then
        echo "✅ SELinux context applied successfully."
    else
        echo "⚠️  Failed to apply SELinux context. You might need to run this manually or check permissions."
    fi
else
    echo "ℹ️  'chcon' not found. Skipping SELinux configuration (not required on non-SELinux systems)."
fi

# -----------------------------------------------------------------------------
# 2. Setup Wrapper Script in ~/bin
# -----------------------------------------------------------------------------
if [ ! -d "$HOME/bin" ]; then
    echo "Directory ~/bin does not exist. Creating..."
    mkdir -p "$HOME/bin"
fi

TARGET_SCRIPT="$HOME/bin/copilot_sandboxed"
echo "Creating wrapper script at $TARGET_SCRIPT..."

cat <<EOF > "$TARGET_SCRIPT"
#!/bin/bash
export PROJECT_ROOT="$PROJECT_ROOT"
export COPILOT_SANDBOXED_HOME="\$PROJECT_ROOT"

# Execute the project script
"\$PROJECT_ROOT/scripts/copilot" "\$@"
EOF

# -----------------------------------------------------------------------------
# 3. Setup jacazul-gemini link in ~/bin
# -----------------------------------------------------------------------------
GEMINI_LINK="$HOME/bin/jacazul-gemini"
if [ ! -L "$GEMINI_LINK" ] && [ ! -f "$GEMINI_LINK" ]; then
    echo "Creating symbolic link for jacazul-gemini at $GEMINI_LINK..."
    ln -s "$PROJECT_ROOT/scripts/jacazul-gemini" "$GEMINI_LINK"
    echo "✅ Link created: $GEMINI_LINK"
else
    echo "ℹ️  $GEMINI_LINK already exists. Skipping link creation."
fi

# -----------------------------------------------------------------------------
# 4. Setup jacazul-opencode link in ~/bin
# -----------------------------------------------------------------------------
OPENCODE_LINK="$HOME/bin/jacazul-opencode"
if [ ! -L "$OPENCODE_LINK" ] && [ ! -f "$OPENCODE_LINK" ]; then
    echo "Creating symbolic link for jacazul-opencode at $OPENCODE_LINK..."
    ln -s "$PROJECT_ROOT/scripts/jacazul-opencode" "$OPENCODE_LINK"
    echo "✅ Link created: $OPENCODE_LINK"
else
    echo "ℹ️  $OPENCODE_LINK already exists. Skipping link creation."
fi

# -----------------------------------------------------------------------------
# 5. Setup jacazul-copilot link in ~/bin
# -----------------------------------------------------------------------------
COPILOT_LINK="$HOME/bin/jacazul-copilot"
if [ ! -L "$COPILOT_LINK" ] && [ ! -f "$COPILOT_LINK" ]; then
    echo "Creating symbolic link for jacazul-copilot at $COPILOT_LINK..."
    ln -s "$PROJECT_ROOT/scripts/jacazul-copilot" "$COPILOT_LINK"
    echo "✅ Link created: $COPILOT_LINK"
else
    echo "ℹ️  $COPILOT_LINK already exists. Skipping link creation."
fi
    
echo ""
echo "Setup complete! You can now run: copilot_sandboxed, jacazul-gemini, jacazul-opencode or jacazul-copilot"
        