#!/bin/bash
# can-copilot: Copilot CLI unhinged (direct execution)

# Get the absolute path to the script's directory  
SCRIPT_DIR="$(dirname "$(readlink -f "$0")")"
PROJECT_ROOT="$(readlink -f "$SCRIPT_DIR/..")"

# -----------------------------------------------------------------------------
# Runtime Bootstrap (Dynamics)
# -----------------------------------------------------------------------------
BOOTSTRAP_ENV="$PROJECT_ROOT/scripts/bootstrap/environment"
if [ -f "$BOOTSTRAP_ENV" ]; then
    source "$BOOTSTRAP_ENV"
else
    echo "‚ùå Jaka runtime environment not found at $BOOTSTRAP_ENV" >&2
    exit 1
fi

# Export all context variables
export PROJECT_ID="$PROJECT_ID"
export CONTEXT_REAL_PATH="$(pwd)"
export CONTEXT_SYSTEM_USER="$(whoami)"
export CONTEXT_GIT_USER="$(git config --global user.name 2>/dev/null || echo "not configured")"
export CONTEXT_GIT_EMAIL="$(git config --global user.email 2>/dev/null || echo "not configured")"
export COPILOT_CUSTOM_INSTRUCTIONS_DIRS="$HOME/.copilot:$HOME/.github/instructions"

# Add workflow scripts to PATH
export PATH="$PATH:$PROJECT_ROOT/templates/skills/taskwarrior_expert/scripts"

# Run GitHub Copilot CLI directly
[ -n "$DEBUG" ] && echo "üêä can-copilot: Starting for project [$PROJECT_ID]"

# DRY RUN: Exit before execution if DRY is set
if [ -n "$DRY" ]; then
    echo "‚úÖ Dry run complete. Copilot bootstrap verified for project [$PROJECT_ID]."
    exit 0
fi

exec copilot "$@"
